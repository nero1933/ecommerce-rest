name: Django CI

on:
  push:
    branches: [ci-cd]
  pull_request:
    branches: [ci-cd]

jobs:
  test:

    runs-on: ubuntu-latest

#    env:
#      POSTGRES_DB: dbname
#      POSTGRES_USER: user
#      POSTGRES_PASSWORD: password
#      SECRET_KEY: 'secret_key'
#      DEBUG: '1'
#      DB_HOST: db
#      DB_NAME: dbname
#      DB_USER: user
#      DB_PASS: password
#      ALLOWED_HOSTS: '127.0.0.1'
#      SENDGRID_API_KEY: none
#      FROM_EMAIL: none
#      USER_CONFIRMATION_KEY: none_{token}
#      PASSWORD_CONFIRMATION_KEY: none_{token}

    env:
      POSTGRES_DB: ${{ DB_NAME }}
      POSTGRES_USER: ${{ DB_USER }}
      POSTGRES_PASSWORD: ${{ DB_PASS }}
      SECRET_KEY: ${{ SECRET_KEY }}
      DEBUG: ${{ DEBUG }}
      DB_HOST: db
      DB_NAME: ${{ DB_NAME }}
      DB_USER: ${{ DB_USER }}
      DB_PASS: ${{ DB_PASS }}
      ALLOWED_HOSTS: ${{ ALLOWED_HOSTS }}
      SENDGRID_API_KEY: ${{ SENDGRID_API_KEY }}
      FROM_EMAIL: ${{ FROM_EMAIL }}
      USER_CONFIRMATION_KEY: ${{ USER_CONFIRMATION_KEY }}
      PASSWORD_CONFIRMATION_KEY: ${{ PASSWORD_CONFIRMATION_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker images
        run: docker compose build

      - name: Make Migrations & Migrate
        run: |
          chmod -R a+w ./app
          docker compose run --rm app sh -c "python manage.py makemigrations ecommerce"
          docker compose run --rm app sh -c "python manage.py migrate"

      - name: Run tests
        run: docker compose run --rm app sh -c "python manage.py test"
